监控系统学习



## 什么是Grafana

Grafana 是一个用来展示各种各样数据的开源软件 。

docker启动grafana

```
version: '2'

services:
  grafana:
    image: grafana/grafana:9.3.16
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    volumes:
      - ./prometheus/data:/prometheus
      - ./prometheus/config:/etc/prometheus

    ports:
      - '9090:9090'


```

浏览器localhost:3000访问grafana

### 配置数据源

之后我们去设置菜单添加 Prometheus 数据源：http://prometheus:9090







### exporter

可以向Prometheus提供监控样本数据的程序都可以被称为一个Exporter

而Exporter的一个实例称为target

#### Node Exporter 收集Host硬件和操作系统信息





#### advisor监控docker

```
docker run \
  --restart=always \
  --volume=/:/rootfs:ro \
  --volume=/var/run:/var/run:rw \
  --volume=/sys/fs/cgroup:/sys/fs/cgroup:ro \
  --volume=/var/lib/docker/:/var/lib/docker:ro \
  --volume=/dev/disk/:/dev/disk:ro \
  --publish=9080:8080 \
  --detach=true \
  --name=cadvisor \
  --privileged \
  --device=/dev/kmsg \
  gcr.io/cadvisor/cadvisor:latest
```

或者使用docker-compose

```
version: '3'
services:
  cadvisor:
    container_name: cadvisor
    image: gcr.io/cadvisor/cadvisor:latest
    privileged: true
    ports:
      - "9080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rr
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
      - /var/lib/docker:/dev/disk:ro
      - /dev/disk/:/dev/disk:ro
    devices:
      - /dev/kmsg:/dev/kmsg
```

dashboard添加https://grafana.com/grafana/dashboards/14282-cadvisor-exporter/ ，id 

安装 node_exporter14282

```
wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.darwin-arm64.tar.gz
tar zxf node_exporter-1.7.0.linux-amd64.tar.gz
cp node_exporter-1.7.0.linux-amd64/node_exporter /usr/bin/
chmod +x /usr/bin/node_exporter

cat <<EOT >>   /etc/systemd/system/node_exporter.service 
[Unit]
Description=Node Exporter
Wants=network-online.target
After=network-online.target

[Service]
User=nobody
ExecStart=/usr/bin/node_exporter

[Install]
WantedBy=default.target

EOT

systemctl daemon-reload
systemctl start node_exporter
systemctl enable node_exporter

```



curl -v localhost:9100/metrics

就可以看到监控指标



## 从Node Exporter收集监控数据

为了能够让Prometheus Server能够从当前node exporter获取到监控数据，这里需要修改Prometheus配置文件。编辑prometheus.yml并在scrape_configs节点下添加以下内容:

```
scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
  # 采集node exporter监控数据
  - job_name: 'node'
    static_configs:
      - targets: ['172.16.40.4:9100']
```



重新启动Prometheus Server

访问http://localhost:9090，进入到Prometheus Server。如果输入“up”并且点击执行按钮以后，可以看到如下结果：

```
up{instance="172.16.40.4:9100", job="node"}  1
up{instance="localhost:9090", job="prometheus"}  1
```

面板 1860

https://grafana.com/grafana/dashboards/1860-node-exporter-full/



#### mysqlexporter



```
CREATE USER 'exporter'@'%' IDENTIFIED BY 'zaq1Exporter' WITH MAX_USER_CONNECTIONS 3;
GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO 'exporter'@'%';

```

docker-compose.yml

```
version: '3'
services:

  mysqlexporter:
    container_name: mysqlexporter
    image: prom/mysqld-exporter
    ports:
      - "9104:9104"
    environment:
      - DATA_SOURCE_NAME=exporter:zaq1Exporter@(172.16.40.4:3306)/
    volumes:
      - ./my.cnf:/.my.cnf
```

my.cnf

```
[client]
user = exporter
password = zaq1Exporter
host = 172.16.40.4
port = 3306
```

dashboard https://grafana.com/grafana/dashboards/14057-mysql/ 14057



 



#### oracledb-exporter

```
version: '3'
services:

  oracledb-exporter:
    container_name: oracledb-exporter
    image: iamseth/oracledb_exporter
    ports:
      - "9161:9161"
    environment:
      - DATA_SOURCE_NAME=oracle://bi:1qaz3EDC@127.0.0.1:1521/orcl

```

使用 https://grafana.com/grafana/dashboards/3333-oracledb/  3333 这个来导入面板



命令行模式

```
export DATA_SOURCE_NAME=oracle://erp_hw:tzDfp6EQEqed@127.0.0.1:1521/hwdb
nohup ./oracledb_exporter --log.level info --web.listen-address 0.0.0.0:9161 &
```



#### windows exporter

https://github.com/prometheus-community/windows_exporter/releases

下载后安装就作为一个单独的服务安装并启动。

面板 13466

https://grafana.com/grafana/dashboards/13466-windows-exporter-for-prometheus-dashboard/
