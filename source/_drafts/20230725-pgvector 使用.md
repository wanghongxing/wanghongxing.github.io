pgvector  使用



使用docker安装

```
version: '2'

services:

  pgvector:
    image: ankane/pgvector:latest
    container_name: pgvector
    restart: always
    ports:
      - 5432:5432
    volumes:
      - ./pg-data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: "whx"

 
```

使用pgcli

```
pgcli -h 127.0.0.1 -U postgres
```

常用postgres 命令：

```
\l：列出所有数据库。
\c [database_name]：连接其他数据库。
\d：列出当前数据库的所有表格。
\d [table_name]：列出某一张表格的结构。
\du：列出所有用户。
\e：打开文本编辑器。
\conninfo：列出当前数据库和连接的信息。
```

常用操作语句

```
# 创建新表
CREATE TABLE user_tbl(name VARCHAR(20), signup_date DATE);

# 插入数据
INSERT INTO user_tbl(name, signup_date) VALUES('张三', '2013-12-22');

# 选择记录
SELECT * FROM user_tbl;

# 更新数据
UPDATE user_tbl set name = '李四' WHERE name = '张三';

# 删除记录
DELETE FROM user_tbl WHERE name = '李四' ;




```

开始pgvector

Enable the extension (do this once in each database where you want to use it)

```tsql
CREATE EXTENSION vector;
```

Create a vector column with 3 dimensions

```sql
CREATE TABLE items (id bigserial PRIMARY KEY, embedding vector(3));
```

Insert vectors

```sql
INSERT INTO items (embedding) VALUES ('[1,2,3]'), ('[4,5,6]');
```

Get the nearest neighbors by L2 distance

```sql
SELECT * FROM items ORDER BY embedding <-> '[3,1,2]' LIMIT 5;
+----+-----------+
| id | embedding |
|----+-----------|
| 1  | [1,2,3]   |
| 2  | [4,5,6]   |
+----+-----------+
```

Get the nearest neighbors to a row

```sql
SELECT * FROM items WHERE id != 1 ORDER BY embedding <-> (SELECT embedding FROM items WHERE id = 1) LIMIT 5;
+----+-----------+
| id | embedding |
|----+-----------|
| 2  | [4,5,6]   |
+----+-----------+


```

Get rows within a certain distance

```sql
SELECT * FROM items WHERE embedding <-> '[3,1,2]' < 5;
+----+-----------+
| id | embedding |
|----+-----------|
| 1  | [1,2,3]   |
+----+-----------+
```

Note: Combine with `ORDER BY` and `LIMIT` to use an index

#### 

#### Distances

Get the distance

```sql
SELECT embedding <-> '[3,1,2]' AS distance FROM items;
+-------------------+
| distance          |
|-------------------|
| 2.449489742783178 |
| 5.744562646538029 |
+-------------------+
```

For inner product, multiply by -1 (since `<#>` returns the negative inner product)

```sql
SELECT (embedding <#> '[3,1,2]') * -1 AS inner_product FROM items;
+---------------+
| inner_product |
|---------------|
| 11.0          |
| 29.0          |
+---------------+
```

For cosine similarity, use 1 - cosine distance

```sql
SELECT 1 - (embedding <=> '[3,1,2]') AS cosine_similarity FROM items;

+--------------------+
| cosine_similarity  |
|--------------------|
| 0.7857142857142857 |
| 0.8832601106161003 |
+--------------------+
```

#### Aggregates

Average vectors

```sql
SELECT AVG(embedding) FROM items;

+---------------+
| avg           |
|---------------|
| [2.5,3.5,4.5] |
+---------------+
```

Average groups of vectors

```sql
SELECT category_id, AVG(embedding) FROM items GROUP BY category_id;

```

## 